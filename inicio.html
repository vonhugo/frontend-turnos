<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Activar kiosko • TurnoLite</title>

  <!-- Fuente usada en index.html -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root {
      /* Variables y colores del sitio de turnos */
      --screen-grad-top: #0073d6;
      --screen-grad-bot: #005bb8;
      --card-bg: #ffffff;
      --card-text: #1c2b3b;
      --shadow-soft: 0 8px 18px rgba(0,0,0,0.2);
      --border-radius-lg: 18px;
      --border-radius-xl: 22px;
      --primary-green: #27ae60;  /* mismo verde de confirmación en index */
      --input-bg: #eaf3ff;       /* pill azul claro usado en campos del index */
      --input-border: #d3deef;
      --error-bg: rgba(255,90,90,.08);
      --error-border: rgba(255,90,90,.25);
      --error-text: #ffb4b4;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
    }

    /* Fondo y layout como la "screen" del index */
    .screen {
      min-height: 100dvh;
      width: 100%;
      background: linear-gradient(180deg, var(--screen-grad-top) 0%, var(--screen-grad-bot) 100%);
      padding: 40px 32px 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Tarjeta central, misma estética de card blanca */
    .card {
      width: min(520px, 100%);
      background: var(--card-bg);
      color: var(--card-text);
      border-radius: var(--border-radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 28px 28px 24px;
    }

    .card h1 {
      margin: 0 0 6px;
      text-align: center;
      font-size: 32px;
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
    }

    .card p {
      margin: 0 0 14px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      opacity: .9;
    }

    /* Campo de token con estilo "pill" azul claro como en index */
    .token-row {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 999px;
      padding: 14px 20px;
      width: 100%;
      margin: 10px auto 8px;
    }
    #token {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: #1c2b3b;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    #token::placeholder { color: #5a6b7c; font-weight: 600; }

    /* Botón primario verde (igual familia visual de confirmaciones) */
    .btn {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 16px 18px;
      font-size: 18px;
      font-weight: 800;
      color: #ffffff;
      background: var(--primary-green);
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,.25);
      margin-top: 10px;
    }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    /* Mensajes */
    .err {
      display: none;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--error-bg);
      border: 1px solid var(--error-border);
      color: var(--error-text);
      text-align: center;
      font-weight: 700;
    }
    .info {
      display: none;
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: rgba(28,43,59,.9);
    }

    /* Footer igual estilo que el index (opcional, pequeño) */
    .app-footer {
      margin-top: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: rgba(28,43,59,.85);
    }
    .app-footer img { width: 28px; height: 28px; object-fit: contain; }
  </style>
</head>
<body>
  <div class="screen">
    <div class="card" role="region" aria-labelledby="title">
      <h1 id="title">ACTIVAR KIOSKO</h1>
      <p>Ingresa el <strong>código de activación</strong> (8–10 caracteres).</p>

      <div class="token-row">
        <input id="token" type="text" inputmode="latin" autocomplete="one-time-code"
               placeholder="ABCD2345" maxlength="12" />
      </div>

      <button id="btn-activate" class="btn">Activar</button>

      <div id="msg-err" class="err" role="alert"></div>
      <div id="msg-info" class="info">Validando credencial existente…</div>

      <div class="app-footer" aria-hidden="true">
        <img src="favicon_ia_v4.png" alt="" />
        <span>© 2026 Palo Alto &amp; Company</span>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const API_BASE = 'https://api-turnos-mamq.onrender.com'; // ajusta si corresponde
    const DEVICE_TOKEN_KEY = 'turnoliteDeviceToken';

    // ===== Storage helpers =====
    const getDeviceToken   = () => { try { return localStorage.getItem(DEVICE_TOKEN_KEY); } catch { return null; } };
    const setDeviceToken   = (t)  => { try { localStorage.setItem(DEVICE_TOKEN_KEY, t); } catch {} };
    const clearDeviceToken = ()   => { try { localStorage.removeItem(DEVICE_TOKEN_KEY); } catch {} };

    // ===== Util: formato dd/mm/aaaa hh:mm (hora local) =====
    function formatDateTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString('es-CL', {
          day: '2-digit', month: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        }).replace(',', '');
      } catch { return null; }
    }

    // ===== Validación de token existente (contra endpoint protegido) =====
    async function validateToken(deviceToken) {
      try {
        const res = await fetch(API_BASE + '/api/health-metric', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + deviceToken },
          body: JSON.stringify({
            pingMs: 1,
            healthUrl: API_BASE + '/api/health',
            page: location.href,
            userAgent: navigator.userAgent,
            screenWidth:  window.screen.width,
            screenHeight: window.screen.height,
            timestamp: new Date().toISOString(),
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || null
          })
        });
        // Alineado a la lógica del index: cualquier 2xx lo tomamos como válido
        return res.status >= 200 && res.status < 300;
      } catch {
        return false;
      }
    }

    // ===== Activación con token humano =====
    async function activateWithToken(rawToken) {
      const elErr = document.getElementById('msg-err');
      elErr.style.display = 'none';

      const token = String(rawToken || '').trim().toUpperCase();
      if (!token) {
        elErr.textContent = 'Debes ingresar un código.';
        elErr.style.display = 'block';
        return;
      }

      const btn = document.getElementById('btn-activate');
      btn.disabled = true;

      try {
        const resp = await fetch(API_BASE + '/api/kiosk/activate', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          const code = data?.error || 'ACTIVATION_FAILED';
          if (code === 'TOKEN_ALREADY_USED') {
            const cuando = data?.usedAt ? formatDateTime(data.usedAt) : null;
            elErr.textContent = cuando
              ? `Este código ya fue usado y se encuentra activo desde el ${cuando}.`
              : 'Este código ya fue usado y se encuentra activo.';
            elErr.style.display = 'block';
            return;
          }
          if (code === 'TOKEN_EXPIRED') {
            elErr.textContent = 'Este código expiró. Solicita uno nuevo.';
            elErr.style.display = 'block';
            return;
          }
          if (code === 'INVALID_TOKEN') {
            elErr.textContent = 'El código ingresado no es válido.';
            elErr.style.display = 'block';
            return;
          }
          elErr.textContent = `No fue posible activar: ${code}.`;
          elErr.style.display = 'block';
          return;
        }

        if (!data?.deviceToken) throw new Error('Respuesta incompleta del servidor.');

        setDeviceToken(data.deviceToken);

        // Validar inmediatamente y redirigir
        const ok = await validateToken(data.deviceToken);
        if (!ok) throw new Error('No se pudo validar la credencial emitida.');
        window.location.replace('index.html');

      } catch (e) {
        clearDeviceToken();
        document.getElementById('msg-err').textContent = e?.message || 'Error de activación.';
        document.getElementById('msg-err').style.display = 'block';
      } finally {
        btn.disabled = false;
      }
    }

    // ===== Boot =====
    (async function boot() {
      // Prefill desde ?k=TOKEN o ?token=TOKEN (cuando abres desde QR)
      const params = new URLSearchParams(window.location.search);
      const k = params.get('k') || params.get('token');
      if (k) document.getElementById('token').value = k.toUpperCase();

      // 1) Si ya hay credenciales, validarlas y pasar directo
      const existing = getDeviceToken();
      if (existing) {
        const info = document.getElementById('msg-info');
        info.style.display = 'block';
        const ok = await validateToken(existing);
        if (ok) {
          window.location.replace('index.html');
          return;
        }
        clearDeviceToken();
        info.style.display = 'none';
      }

      // 2) Solicitar e instalar credenciales
      document.getElementById('btn-activate').onclick = () =>
        activateWithToken(document.getElementById('token').value);

      document.getElementById('token').onkeydown = (ev) => {
        if (ev.key === 'Enter') activateWithToken(ev.target.value);
      };

      document.getElementById('token').focus();
    })();
  </script>
</body>
</html>

