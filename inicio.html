<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Activar kiosko • TurnoLite</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans";
           background:#0b0c10; color:#e9eef3; }
    .wrap { max-width: 460px; margin: 8vh auto; padding: 24px; background:#121319; border-radius:14px;
            box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 8px; font-size:22px; }
    p  { margin:0 0 14px; opacity:.9; }
    input[type=text]{
      width:100%; padding:14px 12px; font-size:18px; border-radius:10px;
      border:1px solid #2a2d38; outline:none; background:#0b0c10; color:#fff;
      letter-spacing:.08em; text-transform:uppercase;
    }
    button{
      width:100%; padding:14px 12px; font-size:18px; border-radius:10px; border:0; cursor:pointer;
      background:#29a37e; color:#0b0c10; font-weight:700; margin-top:12px;
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .err {
      color:#ffb4b4; margin-top:10px; display:none;
      background: rgba(255,90,90,.08); border:1px solid rgba(255,90,90,.25);
      padding:10px 12px; border-radius:10px;
    }
    .info{ font-size:13px; opacity:.85; margin-top:10px; display:none; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Activar kiosko</h1>
    <p>Ingresa el <strong>código de activación</strong> (8–10 caracteres).</p>

    <input id="token" type="text" inputmode="latin" autocomplete="one-time-code"
           placeholder="ABCD2345" maxlength="12" />
    <button id="btn-activate">Activar</button>

    <div id="msg-err" class="err"></div>
    <div id="msg-info" class="info">Validando credencial existente…</div>
  </div>

  <script>
    // ===== Config =====
    const API_BASE = 'https://api-turnos-mamq.onrender.com'; // <-- ajusta si corresponde
    const DEVICE_TOKEN_KEY = 'turnoliteDeviceToken';

    // ===== Storage helpers =====
    const getDeviceToken   = () => { try { return localStorage.getItem(DEVICE_TOKEN_KEY); } catch { return null; } };
    const setDeviceToken   = (t)  => { try { localStorage.setItem(DEVICE_TOKEN_KEY, t); } catch {} };
    const clearDeviceToken = ()   => { try { localStorage.removeItem(DEVICE_TOKEN_KEY); } catch {} };

    // ===== Util: formato dd/mm/aaaa hh:mm (hora local) =====
    function formatDateTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString('es-CL', {
          day: '2-digit', month: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        }).replace(',', '');
      } catch { return null; }
    }

    // ===== Validación del token existente (contra endpoint protegido) =====
    async function validateToken(deviceToken) {
      try {
        const res = await fetch(API_BASE + '/api/health-metric', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + deviceToken },
          body: JSON.stringify({
            pingMs: 1,
            healthUrl: API_BASE + '/api/health',
            page: location.href,
            userAgent: navigator.userAgent,
            screenWidth:  window.screen.width,
            screenHeight: window.screen.height,
            timestamp: new Date().toISOString(),
            timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || null
          })
        });
        // Cualquier 2xx se considera válido para esta verificación
        return res.status >= 200 && res.status < 300;
      } catch {
        // Sin red → no aseguramos validez
        return false;
      }
    }

    // ===== Activación con token humano =====
    async function activateWithToken(rawToken) {
      const elErr = document.getElementById('msg-err');
      elErr.style.display = 'none';

      const token = String(rawToken || '').trim().toUpperCase();
      if (!token) {
        elErr.textContent = 'Debes ingresar un código.'; elErr.style.display = 'block'; return;
      }

      const btn = document.getElementById('btn-activate');
      btn.disabled = true;

      try {
        const resp = await fetch(API_BASE + '/api/kiosk/activate', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await resp.json().catch(() => ({}));

        if (!resp.ok) {
          const code = data?.error || 'ACTIVATION_FAILED';
          if (code === 'TOKEN_ALREADY_USED') {
            const cuando = data?.usedAt ? formatDateTime(data.usedAt) : null;
            elErr.textContent = cuando
              ? `Este código ya fue usado y se encuentra activo desde el ${cuando}.`
              : 'Este código ya fue usado y se encuentra activo.';
            elErr.style.display = 'block';
            return;
          }
          if (code === 'TOKEN_EXPIRED') {
            elErr.textContent = 'Este código expiró. Solicita uno nuevo.';
            elErr.style.display = 'block';
            return;
          }
          if (code === 'INVALID_TOKEN') {
            elErr.textContent = 'El código ingresado no es válido.';
            elErr.style.display = 'block';
            return;
          }
          elErr.textContent = `No fue posible activar: ${code}.`;
          elErr.style.display = 'block';
          return;
        }

        if (!data?.deviceToken) {
          throw new Error('Respuesta incompleta del servidor.');
        }

        setDeviceToken(data.deviceToken);

        // Validación inmediata por robustez
        const ok = await validateToken(data.deviceToken);
        if (!ok) throw new Error('No se pudo validar la credencial emitida.');

        // Redirigir al sistema de turnos
        window.location.replace('index.html');
      } catch (e) {
        clearDeviceToken();
        const msg = (e && e.message) ? e.message : 'Error de activación.';
        document.getElementById('msg-err').textContent = msg;
        document.getElementById('msg-err').style.display = 'block';
      } finally {
        btn.disabled = false;
      }
    }

    // ===== Boot =====
    (async function boot() {
      // Prefill opcional desde ?k=TOKEN o ?token=TOKEN (si abres desde un QR que lo traiga)
      const params = new URLSearchParams(window.location.search);
      const k = params.get('k') || params.get('token');
      if (k) document.getElementById('token').value = k.toUpperCase();

      // 1) Detectar si ya hay credenciales
      const existing = getDeviceToken();
      if (existing) {
        // 2) Validar y redirigir si es correcto
        const info = document.getElementById('msg-info');
        info.style.display = 'block';
        const ok = await validateToken(existing);
        if (ok) {
          window.location.replace('index.html');
          return;
        }
        // Si no valida, limpiar y mostrar UI de activación
        clearDeviceToken();
        info.style.display = 'none';
      }

      // 3) Solicitar e instalar credenciales
      document.getElementById('btn-activate').onclick = () =>
        activateWithToken(document.getElementById('token').value);

      document.getElementById('token').onkeydown = (ev) => {
        if (ev.key === 'Enter') activateWithToken(ev.target.value);
      };

      document.getElementById('token').focus();
    })();
  </script>
</body>
</html>
