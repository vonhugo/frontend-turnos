<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Activar kiosko • TurnoLite</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans";
           background:#0b0c10; color:#e9eef3; }
    .wrap { max-width: 460px; margin: 8vh auto; padding: 24px; background:#121319; border-radius:14px;
            box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 8px; font-size:22px; }
    p  { margin:0 0 14px; opacity:.9; }
    input[type=text]{
      width:100%; padding:14px 12px; font-size:18px; border-radius:10px;
      border:1px solid #2a2d38; outline:none; background:#0b0c10; color:#fff;
      letter-spacing:.08em; text-transform:uppercase;
    }
    button{
      width:100%; padding:14px 12px; font-size:18px; border-radius:10px; border:0; cursor:pointer;
      background:#29a37e; color:#0b0c10; font-weight:700; margin-top:12px;
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .err { color:#ff8b8b; margin-top:10px; display:none; }
    .hint{ font-size:12px; opacity:.75; margin-top:8px }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Activar kiosko</h1>
    <p>Ingresa el <strong>código de activación</strong> (8–10 caracteres).</p>

    <input id="token" type="text" inputmode="latin" autocomplete="one-time-code"
           placeholder="ABCD2345" maxlength="12" />
    <button id="btn-activate">Activar</button>

    <div id="msg-err" class="err"></div>
    <div class="hint">Si este dispositivo ya está activado, te redirigiremos automáticamente.</div>
  </div>

  <script>
    // ===== Config =====
    const API_BASE = 'https://api-turnos-mamq.onrender.com'; // <-- ajusta si corresponde
    const DEVICE_TOKEN_KEY = 'turnoliteDeviceToken';

    // ===== Storage helpers =====
    const getDeviceToken   = () => { try { return localStorage.getItem(DEVICE_TOKEN_KEY) } catch { return null } };
    const setDeviceToken   = (t)  => { try { localStorage.setItem(DEVICE_TOKEN_KEY, t) } catch {} };
    const clearDeviceToken = ()   => { try { localStorage.removeItem(DEVICE_TOKEN_KEY) } catch {} };

    // ===== Activación con token humano =====
    async function activateWithToken(rawToken) {
      const elErr = document.getElementById('msg-err');
      elErr.style.display = 'none';

      const token = String(rawToken || '').trim().toUpperCase();
      if (!token) {
        elErr.textContent = 'Debes ingresar un código.'; elErr.style.display = 'block'; return;
      }

      const btn = document.getElementById('btn-activate');
      btn.disabled = true;

      try {
        const resp = await fetch(API_BASE + '/api/kiosk/activate', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.deviceToken) {
          throw new Error(data?.error || 'No fue posible activar (token inválido, usado o expirado).');
        }

        // Guardar credencial del dispositivo y redirigir al sistema
        setDeviceToken(data.deviceToken);
        window.location.replace('index.html');
      } catch (e) {
        clearDeviceToken();
        elErr.textContent = e.message || 'Error de activación.';
        elErr.style.display = 'block';
      } finally {
        btn.disabled = false;
      }
    }

    // ===== Boot: si ya hay credenciales, redirigir; si no, solicitar token =====
    (function boot() {
      // 1) Detectar si ya hay credenciales
      const existing = getDeviceToken();
      if (existing) {
        // 2) Si existen, redirigir automáticamente a index.html
        window.location.replace('index.html');
        return;
      }

      // 3) Si no existen, preparar UI para solicitar y registrar
      // Prefill opcional si viene ?k=TOKEN en la URL (útil al abrir desde un QR)
      const params = new URLSearchParams(window.location.search);
      const k = params.get('k') || params.get('token');
      if (k) document.getElementById('token').value = k.toUpperCase();

      document.getElementById('btn-activate').onclick = () =>
        activateWithToken(document.getElementById('token').value);

      document.getElementById('token').onkeydown = (ev) => {
        if (ev.key === 'Enter') activateWithToken(ev.target.value);
      };

      document.getElementById('token').focus();
    })();
  </script>
</body>
</html>
