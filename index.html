<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pantalla de Turnos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Guard: si no hay token → ir a inicio.html -->
  <script>
  (function () {
    var KEY = 'turnoliteDeviceToken';
    try {
      var t = localStorage.getItem(KEY);
      if (!t) {
        var back = encodeURIComponent((location.pathname || '/index.html').replace(/^\//,''));
        location.replace('inicio.html?next=' + back);
        return;
      }
      window.__TURNOLITE_TOKEN__ = t; // a mano para otros scripts
    } catch (e) {
      location.replace('inicio.html');
    }
  })();
  </script>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root {
      --screen-bg: #0073d6;
      --header-text: #f4f8ff;
      --row-active-bg: #d8ecff;
      --row-active-text: #1c2b3b;
      --row-bg: #0f7fe5;
      --row-text: #f4f8ff;
      --current-call-bg: #27ae60;
      --current-call-text: #ffffff;
      --card-bg: #ffffff;
      --primary-option-bg: #0f7fe5;
      --primary-option-text: #ffffff;
      --secondary-option-bg: #d8ecff;
      --secondary-option-text: #1c2b3b;
      --divider-color: rgba(255, 255, 255, 0.5);
      --shadow-soft: 0 8px 18px rgba(0, 0, 0, 0.2);
      --border-radius-lg: 18px;
      --border-radius-xl: 22px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont,"Segoe UI", sans-serif;
    }

    .screen {
      width: 100vw;
      max-width: 100%;
      height: 100dvh;
      background: linear-gradient(180deg, #0073d6 0%, #005bb8 100%);
      padding: 40px 32px 36px;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 24px;
      box-sizing: border-box;
    }

    .main-layout {
      flex: 1;
      display: grid;
      grid-template-columns: 0.8fr 1.6fr;
      gap: 32px;
      align-items: stretch;
      min-height: 0;
    }
    .main-layout__left, .main-layout__right {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* LLAMANDO AHORA */
    .current-call {
      flex: 0 0 auto;
      background: var(--current-call-bg);
      border-radius: var(--border-radius-xl);
      padding: 28px 24px;
      min-height: 190px;
      text-align: center;
      color: var(--current-call-text);
      box-shadow: var(--shadow-soft);
      margin-bottom: 18px;
    }
    .current-call__label { font-size: 42px; font-weight: 700; letter-spacing: .12em; text-transform: uppercase; margin-bottom: 24px; }
    .current-call__name  { font-size: 54px; font-weight: 800; margin-bottom: 6px; }
    .current-call__module{ font-size: 32px; font-weight: 700; text-transform: uppercase; }

    /* ÚLTIMOS LLAMADOS */
    .latest-calls { flex: 1; display: flex; flex-direction: column; }
    .latest-calls__title { text-align: center; font-size: 42px; font-weight: 800; letter-spacing: 0.12em; text-transform: uppercase; color: var(--header-text); margin: 0 0 18px; }
    .latest-calls__list  { display: flex; flex-direction: column; gap: 10px; }
    .call-row { display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-radius: var(--border-radius-lg); font-size: 32px; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,.18); }
    .call-row--active  { background: var(--row-active-bg); color: var(--row-active-text); }
    .call-row--default { background: var(--row-bg); color: var(--row-text); }
    .call-row__name   { flex: 1; }
    .call-row__module { flex: 0 0 auto; margin-left: 16px; }

    /* TOMA TU TURNO */
    .take-turn { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; }
    .take-turn__card { background: var(--card-bg); border-radius: var(--border-radius-xl); padding: 30px 32px 36px; box-shadow: var(--shadow-soft); display: flex; flex-direction: column; gap: 24px; height: 100%; }
    .take-turn__title { text-align: center; font-size: 42px; font-weight: 800; letter-spacing: .12em; text-transform: uppercase; color: #1c2b3b; margin-bottom: 4px; }

    .turno-view[hidden] { display: none; }

    .take-turn__subtitle    { text-align: center; font-size: 22px; font-weight: 700; color: #1c2b3b; margin: 0 0 8px; }
    .take-turn__description { text-align: center; font-size: 20px; font-weight: 500; color: #1c2b3b; margin: 0 0 18px; }

    .take-turn__options { display: flex; flex-direction: column; gap: 22px; }
    .option { border-radius: var(--border-radius-lg); padding: 16px 26px; display: flex; align-items: center; gap: 24px; font-size: 32px; font-weight: 600; cursor: pointer; transition: transform .15s ease-out, box-shadow .15s ease-out; }
    .option:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0,0,0,.25); }
    .option__text { flex: 1; line-height: 1.2; }
    .option__subtitle { display: block; font-size: 22px; font-weight: 500; opacity: .85; }
    .option__arrow { font-size: 34px; font-weight: 700; }
    .option--pref { background: var(--primary-option-bg); color: var(--primary-option-text); border: 2px solid #0d6bd6; }
    .option--cell { background: #f0f6ff; color: #123057; border: 2px solid #d0e2ff; }
    .option--name { background: #ffe6f1; color: #311323; border: 2px solid #ffc2dd; }

    @keyframes option-hint-pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0); } 50% { transform: scale(1.04); box-shadow: 0 0 0 6px rgba(255,255,255,.7), 0 8px 18px rgba(0,0,0,.35); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0); } }
    .option--hint { animation: option-hint-pulse .9s ease-out; }

    .qr-icon, .pref-icon, .idcard-icon { width: 64px; height: 64px; flex: 0 0 auto; padding: 0; background: transparent; border-radius: 0; box-shadow: none; display: flex; align-items: center; justify-content: center; }
    .qr-icon svg, .pref-icon svg, .idcard-icon svg { width: 100%; height: 100%; display: block; }
    .option--pref .pref-icon svg * { fill: #ffffff !important; stroke: none !important; }
    .option--cell .qr-icon { color: #000000; }
    .option--name .idcard-icon svg { fill: none; stroke: #e08abc; stroke-width: 2.2; }
    .option--name .idcard-icon svg .badge { fill: #f8c0d8; stroke: none; }

    .person-icon { width: 94px; height: 94px; flex: 0 0 auto; background: #ffffff; border-radius: 100px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,.2); }
    .person-icon__inner { width: 61px; height: 61px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ff6b6b 0, #e63757 40%, #b3203a 100%); position: relative; }
    .person-icon__inner::before, .person-icon__inner::after { content: ""; position: absolute; left: 50%; transform: translateX(-50%); background: #f2f2f2; }
    .person-icon__inner::before { top: 7px; width: 18px; height: 18px; border-radius: 50%; }
    .person-icon__inner::after  { bottom: 4px; width: 28px; height: 14px; border-radius: 14px 14px 8px 8px; }

    .name-input-row { display: flex; align-items: center; gap: 14px; background: #eaf3ff; border-radius: 999px; padding: 14px 22px; box-shadow: 0 2px 4px rgba(0,0,0,.08) inset; width: 60%; max-width: 420px; margin: 0 auto 16px; }
    .name-input-row .person-icon { width: 50px; height: 50px; box-shadow: none; }
    .name-input-row__display { flex: 1; font-size: 26px; font-family: inherit; font-weight: 600; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .name-input-row__display--placeholder { color: #5a6b7c; }

    .cell-input-row, .rut-input-row { position: relative; display: flex; align-items: center; gap: 10px; background: #eaf3ff; border-radius: 999px; padding: 18px 26px; box-shadow: inset 0 2px 4px rgba(0,0,0,.08); width: 60%; max-width: 420px; margin: 0 auto 8px; }
    .cell-input-prefix { font-size: 28px; font-weight: 700; color: #1c2b3b; padding-left: 2px; }
    .cell-input, .rut-input { flex: 1; border: none; background: transparent; font-size: 28px; font-family: inherit; color: #1c2b3b; outline: none; text-align: left; }
    .cell-input::placeholder { color: #5a6b7c; }
    .cell-input-error { min-height: 22px; text-align: center; font-size: 16px; font-weight: 600; color: #c0392b; margin: 0 0 2px; }

    .virtual-keyboard { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; padding: 0 24px; box-sizing: border-box; }
    .virtual-keyboard__row { display: flex; justify-content: center; gap: 14px; }
    .virtual-keyboard__row--actions { margin-top: 24px; margin-bottom: 32px; }
    .virtual-keyboard__key { min-width: 80px; min-height: 80px; padding: 16px 20px; border-radius: 999px; border: none; background: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,.18); font-size: 30px; font-weight: 600; font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color: #1c2b3b; cursor: pointer; }
    .virtual-keyboard__key--action { background: #f3f6fb; color: #1c2b3b; font-size: 22px; font-weight: 600; border: 1px solid #d3deef; box-shadow: 0 2px 4px rgba(0,0,0,.08); }
    .virtual-keyboard__key--space { min-width: 260px; }

    .virtual-keyboard--name, .virtual-keyboard--numeric, .virtual-keyboard--rut { margin-top: 12px; }
    .virtual-keyboard--name .virtual-keyboard__row, .virtual-keyboard--numeric .virtual-keyboard__row, .virtual-keyboard--rut .virtual-keyboard__row { gap: 10px; }
    .virtual-keyboard--name .virtual-keyboard__key, .virtual-keyboard--numeric .virtual-keyboard__key, .virtual-keyboard--rut .virtual-keyboard__key { min-width: 64px; min-height: 64px; padding: 10px 14px; font-size: 24px; }
    .virtual-keyboard--name .virtual-keyboard__row--actions, .virtual-keyboard--numeric .virtual-keyboard__row--actions, .virtual-keyboard--rut .virtual-keyboard__row--actions { margin-top: 16px; margin-bottom: 20px; }
    .virtual-keyboard--name .virtual-keyboard__key--space { min-width: 200px; }

    .button-row { display: flex; flex-direction: row; justify-content: center; gap: 12px; margin-top: 16px; }
    .btn-turn { border: none; border-radius: 999px; padding: 14px 18px; font-size: 22px; font-weight: 700; font-family: inherit; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-turn--primary { background: var(--current-call-bg); color: #ffffff; box-shadow: 0 4px 10px rgba(0,0,0,.25); }
    .btn-turn--secondary { background: #ffffff; color: var(--primary-option-bg); border: 2px solid var(--primary-option-bg); }
    .btn-turn--disabled { opacity: .5; cursor: default; }
    @keyframes btn-turn-pulse-outline { 0% { outline: 0 solid rgba(255,77,79,0); box-shadow: 0 0 0 0 rgba(255,77,79,0); } 50% { outline: 4px solid rgba(255,77,79,.95); box-shadow: 0 0 0 8px rgba(255,77,79,.4); } 100% { outline: 0 solid rgba(255,77,79,0); box-shadow: 0 0 0 0 rgba(255,77,79,0); } }
    .btn-turn--pulse { outline-offset: 3px; animation: btn-turn-pulse-outline 1s ease-out infinite; }
    .btn-turn__icon { font-size: 24px; line-height: 1; }

    .app-footer { margin-top: 16px; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 18px; font-weight: 600; color: rgba(255,255,255,.85); opacity: .95; }
    .app-footer__logo { width: 36px; height: 36px; object-fit: contain; }
    .app-footer__text { text-transform: none; letter-spacing: .04em; }
    .app-footer__status { display: flex; align-items: center; gap: 6px; margin-left: 12px; font-size: 14px; font-weight: 500; }
    .status-led { width: 14px; height: 14px; border-radius: 50%; background: rgba(255,255,255,.35); box-shadow: 0 0 0 2px rgba(0,0,0,.25); }
    .status-led--ok { background: #2ecc71; }
    .status-led--error { background: #e74c3c; }
    .status-led--checking { background: #f1c40f; }
    .status-text { white-space: nowrap; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: flex; align-items: center; justify-content: center; z-index: 999; }
    .modal-backdrop[hidden] { display: none; }
    .modal-turno { background: #ffffff; border-radius: 22px; padding: 36px 44px; max-width: 600px; width: min(92%, 600px); text-align: center; box-shadow: 0 12px 30px rgba(0,0,0,.35); color: #1c2b3b; }
    .modal-turno__title { font-size: 42px; font-weight: 800; margin: 0 0 12px; }
    .modal-turno__text  { font-size: 36px; font-weight: 500; margin: 0 0 20px; }

    @media (max-width: 1200px) {
      .screen { padding: 24px 20px; }
      .main-layout { gap: 24px; }
      .current-call__label { font-size: 32px; } .current-call__name { font-size: 40px; } .current-call__module { font-size: 24px; }
      .latest-calls__title { font-size: 32px; margin-bottom: 12px; }
      .call-row { font-size: 22px; padding: 10px 18px; }
      .take-turn__card { padding: 20px 22px 24px; max-height: calc(100vh - 140px); overflow-y: auto; }
      .take-turn__title { font-size: 32px; } .take-turn__subtitle { font-size: 18px; } .take-turn__description { font-size: 16px; }
      .option { padding: 12px 18px; font-size: 24px; }
      .option__subtitle { font-size: 18px; }
      .qr-icon, .pref-icon, .idcard-icon, .person-icon { width: 72px; height: 72px; }
      .person-icon__inner { width: 46px; height: 46px; }
      .virtual-keyboard--name .virtual-keyboard__key,
      .virtual-keyboard--numeric .virtual-keyboard__key,
      .virtual-keyboard--rut .virtual-keyboard__key { min-width: 56px; min-height: 56px; padding: 8px 10px; font-size: 20px; }
      .virtual-keyboard--name .virtual-keyboard__row--actions,
      .virtual-keyboard--numeric .virtual-keyboard__row--actions,
      .virtual-keyboard--rut .virtual-keyboard__row--actions { margin-top: 14px; margin-bottom: 16px; }
      .btn-turn { padding: 10px 14px; font-size: 18px; }
    }
    @media (max-width: 1024px) { .main-layout { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
      .screen { width: 100%; height: auto; max-height: none; padding: 24px 16px; }
      .latest-calls__title { font-size: 30px; }
      .call-row { font-size: 20px; }
      .current-call__name { font-size: 36px; }
      .take-turn__title { font-size: 28px; }
      .option { font-size: 22px; }
      .take-turn__subtitle { font-size: 18px; }
      .take-turn__description { font-size: 16px; }
      .name-input-row__display { font-size: 20px; }
      .btn-turn { font-size: 18px; }
      .name-input-row, .cell-input-row, .rut-input-row { width: 100%; max-width: none; }
    }
  </style>
</head>
<body>
  <!-- PANTALLA PRINCIPAL -->
  <div class="screen screen--main" id="screen-main">
    <div class="main-layout">
      <!-- Izquierda: LLAMANDO AHORA + ÚLTIMOS LLAMADOS -->
      <div class="main-layout__left">
        <section class="current-call" aria-labelledby="current-call-title">
          <div id="current-call-title" class="current-call__label">LLAMANDO</div>
          <div class="current-call__name">JUAN PABLO</div>
          <div class="current-call__module">MÓDULO 2</div>
        </section>

        <section class="latest-calls" aria-labelledby="latest-calls-title">
          <h1 id="latest-calls-title" class="latest-calls__title">ÚLTIMOS LLAMADOS</h1>
          <div class="latest-calls__list">
            <div class="call-row call-row--active"><span class="call-row__name">Juan P.</span><span class="call-row__module">Módulo 1</span></div>
            <div class="call-row call-row--default"><span class="call-row__name">Ana M.</span><span class="call-row__module">Módulo 1</span></div>
            <div class="call-row call-row--default"><span class="call-row__name">Carlos R.</span><span class="call-row__module">Módulo 3</span></div>
            <div class="call-row call-row--default"><span class="call-row__name">María S.</span><span class="call-row__module">Módulo 1</span></div>
            <div class="call-row call-row--default"><span class="call-row__name">Luis F.</span><span class="call-row__module">Despacho</span></div>
          </div>
        </section>
      </div>

      <!-- Derecha: TOMA TU TURNO -->
      <div class="main-layout__right">
        <section class="take-turn" aria-labelledby="take-turn-title">
          <div class="take-turn__card">
            <h2 id="take-turn-title" class="take-turn__title">TOMA TU TURNO</h2>

            <div id="take-turn-views">
              <!-- Vista 1: Menú -->
              <div class="turno-view" id="view-menu">
                <div class="take-turn__options">
                  <div class="option option--pref" data-view-target="view-presencial" aria-label="Tomar turno preferencial">
                    <div class="pref-icon" aria-hidden="true">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-wheelchair" viewBox="0 0 16 16">
                        <path d="M12 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3m-.663 2.146a1.5 1.5 0 0 0-.47-2.115l-2.5-1.508a1.5 1.5 0 0 0-1.676.086l-2.329 1.75a.866.866 0 0 0 1.051 1.375L7.361 3.37l.922.71-2.038 2.445A4.73 4.73 0 0 0 2.628 7.67l1.064 1.065a3.25 3.25 0 0 1 4.574 4.574l1.064 1.063a4.73 4.73 0 0 0 1.09-3.998l1.043-.292-.187 2.991a.872.872 0 1 0 1.741.098l.206-4.121A1 1 0 0 0 12.224 8h-2.79zM3.023 9.48a3.25 3.25 0 0 0 4.496 4.496l1.077 1.077a4.75 4.75 0 0 1-6.65-6.65z"/>
                      </svg>
                    </div>
                    <div class="option__text">Tomar turno preferencial<br /><span class="option__subtitle">Toca aquí para ingresar tu rut</span></div>
                    <div class="option__arrow" aria-hidden="true">›</div>
                  </div>

                  <div class="option option--cell" data-view-target="view-cell">
                    <div class="qr-icon" aria-hidden="true">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp" viewBox="0 0 16 16">
                        <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/>
                      </svg>
                    </div>
                    <div class="option__text">Tomar turno con mi celular<br /><span class="option__subtitle">Toca aquí para ingresar tu celular</span></div>
                    <div class="option__arrow" aria-hidden="true">›</div>
                  </div>

                  <div class="option option--name" data-view-target="view-name">
                    <div class="idcard-icon" aria-hidden="true">
                      <svg viewBox="0 0 64 64" role="presentation">
                        <rect x="6" y="10" width="52" height="44" rx="6" ry="6" fill="#ffe6f1" stroke="#e08abc" stroke-width="3"/>
                        <circle cx="24" cy="28" r="7" fill="#f8c0d8"/>
                        <rect x="16" y="36" width="16" height="6" rx="3" fill="#f8c0d8"/>
                        <rect x="34" y="22" width="16" height="4" rx="2" fill="#e08abc"/>
                        <rect x="34" y="30" width="16" height="4" rx="2" fill="#e08abc"/>
                        <rect x="34" y="38" width="12" height="4" rx="2" fill="#e08abc"/>
                      </svg>
                    </div>
                    <div class="option__text">Tomar turno solo con mi nombre<br /><span class="option__subtitle">Toca aquí para escribir tu nombre</span></div>
                    <div class="option__arrow" aria-hidden="true">›</div>
                  </div>
                </div>
              </div>

              <!-- Vista 2: Preferencial (RUT) -->
              <div class="turno-view" id="view-presencial" hidden>
                <p class="take-turn__subtitle">Para tomar tu turno preferencial</p>
                <div class="rut-input-row">
                  <input type="text" id="rut-input" class="rut-input" inputmode="numeric" autocomplete="off" placeholder="Escribe tu RUT" readonly />
                </div>
                <p class="cell-input-error" id="rut-error" aria-live="polite"></p>
                <div class="virtual-keyboard virtual-keyboard--rut" aria-label="Teclado RUT">
                  <div class="virtual-keyboard__row"><button class="virtual-keyboard__key" data-key="7">7</button><button class="virtual-keyboard__key" data-key="8">8</button><button class="virtual-keyboard__key" data-key="9">9</button></div>
                  <div class="virtual-keyboard__row"><button class="virtual-keyboard__key" data-key="4">4</button><button class="virtual-keyboard__key" data-key="5">5</button><button class="virtual-keyboard__key" data-key="6">6</button></div>
                  <div class="virtual-keyboard__row"><button class="virtual-keyboard__key" data-key="1">1</button><button class="virtual-keyboard__key" data-key="2">2</button><button class="virtual-keyboard__key" data-key="3">3</button></div>
                  <div class="virtual-keyboard__row virtual-keyboard__row--actions">
                    <button class="virtual-keyboard__key virtual-keyboard__key--action" data-key="BACKSPACE">Borrar</button>
                    <button class="virtual-keyboard__key" data-key="0">0</button>
                    <button class="virtual-keyboard__key virtual-keyboard__key--action" data-key="CLEAR">Limpiar</button>
                  </div>
                </div>
                <div class="button-row">
                  <button type="button" class="btn-turn btn-turn--primary btn-turn--disabled" id="btn-confirmar-rut" disabled><span class="btn-turn__icon">✓</span><span>Confirmar turno preferencial</span></button>
                  <button type="button" class="btn-turn btn-turn--secondary" id="btn-volver-menu-rut"><span class="btn-turn__icon">←</span><span>Volver a opciones</span></button>
                </div>
              </div>

              <!-- Vista 3: Celular -->
              <div class="turno-view" id="view-cell" hidden>
                <p class="take-turn__subtitle">Ingresa un número de celular para contactarte</p>
                <div class="cell-input-row">
                  <span class="cell-input-prefix">+56</span>
                  <input type="tel" id="celular-input" class="cell-input" inputmode="tel" autocomplete="off" placeholder="" readonly />
                </div>
                <p class="cell-input-error" id="celular-error" aria-live="polite"></p>
                <div class="virtual-keyboard virtual-keyboard--numeric" aria-label="Teclado numérico">
                  <div class="virtual-keyboard__row"><button class="virtual-keyboard__key" data-key="7">7</button><button class="virtual-keyboard__key" data-key="8">8</button><button class="virtual-keyboard__key" data-key="9">9</button></div>
                  <div class="virtual-keyboard__row"><button class="virtual-keyboard__key" data-key="4">4</button><button class="virtual-keyboard__key" data-key="5">5</button><button class="virtual-keyboard__key" data-key="6">6</button></div>
                  <div class="virtual-keyboard__row"><button class="virtual-keyboard__key" data-key="1">1</button><button class="virtual-keyboard__key" data-key="2">2</button><button class="virtual-keyboard__key" data-key="3">3</button></div>
                  <div class="virtual-keyboard__row virtual-keyboard__row--actions"><button class="virtual-keyboard__key virtual-keyboard__key--action" data-key="BACKSPACE">Borrar</button><button class="virtual-keyboard__key" data-key="0">0</button><button class="virtual-keyboard__key virtual-keyboard__key--action" data-key="CLEAR">Limpiar</button></div>
                </div>
                <div class="button-row">
                  <button type="button" class="btn-turn btn-turn--primary btn-turn--disabled" id="btn-confirmar-celular" disabled><span class="btn-turn__icon">✓</span><span>Confirmar turno</span></button>
                  <button type="button" class="btn-turn btn-turn--secondary" id="btn-volver-menu-cell"><span class="btn-turn__icon">←</span><span>Volver a opciones</span></button>
                </div>
              </div>

              <!-- Vista 4: Nombre -->
              <div class="turno-view" id="view-name" hidden>
                <p class="take-turn__subtitle">Te recomendamos agregar la primera letra de tu apellido.</p>
                <div class="name-input-row">
                  <div class="name-input-row__display name-input-row__display--placeholder" id="nombre-display" role="textbox" aria-label="Nombre para llamarte">Toca las letras para escribir tu nombre</div>
                  <input type="hidden" id="nombre-sin-celular" name="nombre" autocomplete="off" />
                </div>
                <div class="virtual-keyboard virtual-keyboard--name" aria-label="Teclado para escribir tu nombre">
                  <div class="virtual-keyboard__row"><button class="virtual-keyboard__key" data-key="Q">Q</button><button class="virtual-keyboard__key" data-key="W">W</button><button class="virtual-keyboard__key" data-key="E">E</button><button class="virtual-keyboard__key" data-key="R">R</button><button class="virtual-keyboard__key" data-key="T">T</button><button class="virtual-keyboard__key" data-key="Y">Y</button><button class="virtual-keyboard__key" data-key="U">U</button><button class="virtual-keyboard__key" data-key="I">I</button><button class="virtual-keyboard__key" data-key="O">O</button><button class="virtual-keyboard__key" data-key="P">P</button></div>
                  <div class="virtual-keyboard__row"><button class="virtual-keyboard__key" data-key="A">A</button><button class="virtual-keyboard__key" data-key="S">S</button><button class="virtual-keyboard__key" data-key="D">D</button><button class="virtual-keyboard__key" data-key="F">F</button><button class="virtual-keyboard__key" data-key="G">G</button><button class="virtual-keyboard__key" data-key="H">H</button><button class="virtual-keyboard__key" data-key="J">J</button><button class="virtual-keyboard__key" data-key="K">K</button><button class="virtual-keyboard__key" data-key="L">L</button></div>
                  <div class="virtual-keyboard__row"><button class="virtual-keyboard__key" data-key="Z">Z</button><button class="virtual-keyboard__key" data-key="X">X</button><button class="virtual-keyboard__key" data-key="C">C</button><button class="virtual-keyboard__key" data-key="V">V</button><button class="virtual-keyboard__key" data-key="B">B</button><button class="virtual-keyboard__key" data-key="N">N</button><button class="virtual-keyboard__key" data-key="M">M</button></div>
                  <div class="virtual-keyboard__row virtual-keyboard__row--actions"><button class="virtual-keyboard__key virtual-keyboard__key--action" data-key="BACKSPACE">Borrar</button><button class="virtual-keyboard__key virtual-keyboard__key--action virtual-keyboard__key--space" data-key="SPACE">Espacio</button></div>
                </div>
                <div class="button-row">
                  <button type="button" class="btn-turn btn-turn--primary btn-turn--disabled" id="btn-confirmar-nombre" disabled><span class="btn-turn__icon">✓</span><span>Confirmar turno</span></button>
                  <button type="button" class="btn-turn btn-turn--secondary" id="btn-volver-menu-name"><span class="btn-turn__icon">←</span><span>Volver a opciones</span></button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <footer class="app-footer">
      <img src="favicon_ia_v4.png" alt="Palo Alto &amp; Company" class="app-footer__logo" />
      <span class="app-footer__text">© 2026 Palo Alto &amp; Company | +569 3575751</span>
      <div class="app-footer__status" aria-label="Estado de conexión con el servidor">
        <span class="status-led" id="health-led"></span>
        <span class="status-text" id="health-text">Verificando…</span>
      </div>
    </footer>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="turno-modal" hidden>
    <div class="modal-turno" role="dialog" aria-modal="true" aria-labelledby="turno-modal-title">
      <h2 id="turno-modal-title" class="modal-turno__title">¡Gracias!</h2>
      <p class="modal-turno__text">Tu turno ha sido registrado. Serás llamado(a) a la brevedad.</p>
    </div>
  </div>

  <script>
  (function () {
    // -------- Configuración API --------
    const API_URL            = "https://api-turnos-mamq.onrender.com/api/turno";
    const HEALTH_URL         = "https://api-turnos-mamq.onrender.com/api/health-auth"; // ahora autenticado
    const HEALTH_METRICS_URL = "https://api-turnos-mamq.onrender.com/api/health-metric";
    const HEALTH_INTERVAL_MS = 15000;

    // -------- Helpers de Auth (Bearer deviceToken) --------
    const KEY = 'turnoliteDeviceToken';
    function getToken() {
      try { return window.__TURNOLITE_TOKEN__ || localStorage.getItem(KEY); } catch { return null; }
    }
    function ensureToken() {
      const t = getToken();
      if (!t) { try{localStorage.removeItem(KEY);}catch{}; location.replace('inicio.html'); throw new Error('NO_DEVICE_TOKEN'); }
      return t;
    }
    async function fetchWithAuth(url, options) {
      options = options || {};
      const t = ensureToken();
      const headers = new Headers(options.headers || {});
      if (!headers.has('Authorization')) headers.set('Authorization', 'Bearer ' + t);
      if (options.body && !headers.has('Content-Type')) headers.set('Content-Type', 'application/json');
      return fetch(url, { ...options, headers });
    }
    async function postJsonAuth(url, body, extra) {
      const res = await fetchWithAuth(url, { method: 'POST', body: JSON.stringify(body || {}), ...(extra || {}) });
      let data = null; try { data = await res.json(); } catch {}
      if (!res.ok) throw new Error((data && data.error) || ('HTTP_' + res.status));
      return data || {};
    }

    // -------- Identidad multi-cliente (si la usas en la URL) --------
    const urlParams   = new URLSearchParams(window.location.search);
    const CLIENTE_ID  = urlParams.get('cliente')  || 'default';
    const SUCURSAL_ID = urlParams.get('sucursal') || null;
    const KIOSCO_ID   = urlParams.get('kiosco')   || null;

    // -------- Estado visual del health --------
    const healthLed  = document.getElementById('health-led');
    const healthText = document.getElementById('health-text');
    function setHealthState(state) {
      if (!healthLed || !healthText) return;
      healthLed.classList.remove('status-led--ok','status-led--error','status-led--checking');
      if (state === 'ok')      { healthLed.classList.add('status-led--ok');      healthText.textContent = 'Servicios en línea'; }
      else if (state === 'error'){ healthLed.classList.add('status-led--error'); healthText.textContent = 'Sin conexión con servidor'; }
      else                     { healthLed.classList.add('status-led--checking');healthText.textContent = 'Verificando…'; }
    }

    async function reportHealthMetric(pingMs) {
      try {
        await postJsonAuth(HEALTH_METRICS_URL, {
          pingMs,
          healthUrl: HEALTH_URL,
          page: location.href,
          userAgent: navigator.userAgent,
          screenWidth:  window.screen?.width,
          screenHeight: window.screen?.height,
          timestamp: new Date().toISOString(),
          timeZone: (Intl.DateTimeFormat().resolvedOptions().timeZone || null),
          // opcional si quieres seguir enviando (backend ya deduce desde token):
          clienteId:  CLIENTE_ID,
          sucursalId: SUCURSAL_ID,
          kioscoId:   KIOSCO_ID
        }, { keepalive: true });
      } catch (e) {
        console.warn('[turnolite] health-metric no enviado:', e?.message || e);
      }
    }

    async function checkHealthOnce() {
      try {
        setHealthState('checking');
        const t0 = performance.now();
        const resp = await fetchWithAuth(HEALTH_URL, { method: 'GET', cache: 'no-store' });
        const t1 = performance.now();
        const pingMs = Math.round(t1 - t0);
        if (!resp.ok) { setHealthState('error'); return; }
        setHealthState('ok');
        reportHealthMetric(pingMs);
      } catch (e) {
        console.error('[turnolite] Error health:', e);
        setHealthState('error');
      }
    }
    function startHealthPolling(){ checkHealthOnce(); setInterval(checkHealthOnce, HEALTH_INTERVAL_MS); }

    // -------- Resto de la lógica de UI (idéntica a tu versión) --------
    const mainScreen = document.getElementById('screen-main');
    const viewMenu       = document.getElementById('view-menu');
    const viewPresencial = document.getElementById('view-presencial');
    const viewCell       = document.getElementById('view-cell');
    const viewName       = document.getElementById('view-name');
    const viewButtons    = document.querySelectorAll('[data-view-target]');

    const nombreDisplay    = document.getElementById('nombre-display');
    const nombreInput      = document.getElementById('nombre-sin-celular');
    const nombreKeys       = document.querySelectorAll('.virtual-keyboard--name .virtual-keyboard__key');
    const btnConfirmNombre = document.getElementById('btn-confirmar-nombre');
    const btnVolverName    = document.getElementById('btn-volver-menu-name');

    const cellInput      = document.getElementById('celular-input');
    const cellError      = document.getElementById('celular-error');
    const numericKeys    = document.querySelectorAll('.virtual-keyboard--numeric .virtual-keyboard__key');
    const btnConfirmCell = document.getElementById('btn-confirmar-celular');
    const btnVolverCell  = document.getElementById('btn-volver-menu-cell');

    const rutInput      = document.getElementById('rut-input');
    const rutError      = document.getElementById('rut-error');
    const rutKeys       = document.querySelectorAll('.virtual-keyboard--rut .virtual-keyboard__key');
    const btnConfirmRut = document.getElementById('btn-confirmar-rut');
    const btnVolverRut  = document.getElementById('btn-volver-menu-rut');

    const turnoModal = document.getElementById('turno-modal');

    const MAX_CELL_DIGITS = 9;
    const MAX_NAME_CHARS  = 10;
    const MAX_RUT_DIGITS  = 8;

    let activeViewId      = 'view-menu';
    let inactivityTimerId = null;
    let modalTimerId      = null;

    function sanitizePhone(v){ return (v||'').replace(/\D/g,''); }

    // Cambio de vistas
    function showView(id){
      activeViewId = id;
      if (viewMenu)       viewMenu.hidden       = (id !== 'view-menu');
      if (viewPresencial) viewPresencial.hidden = (id !== 'view-presencial');
      if (viewCell)       viewCell.hidden       = (id !== 'view-cell');
      if (viewName)       viewName.hidden       = (id !== 'view-name');
      if (id === 'view-menu') clearInactivityTimer(); else resetInactivityTimer();
    }
    function getInactivityLimit(){
      if (activeViewId === 'view-name')  { const n = (nombreInput?.value||'').trim(); return n.length>=3 ? 10000 : 5000; }
      if (activeViewId === 'view-cell')  { const d = sanitizePhone(cellInput?.value||''); return d.length===MAX_CELL_DIGITS ? 10000 : 5000; }
      if (activeViewId === 'view-presencial'){ const len = (rutInput?.value||'').replace(/\D/g,'').length; return len>=7 ? 10000 : 5000; }
      return 5000;
    }
    function clearInactivityTimer(){ if (inactivityTimerId!==null){ clearTimeout(inactivityTimerId); inactivityTimerId=null; } }
    function resetInactivityTimer(){ clearInactivityTimer(); inactivityTimerId=setTimeout(function(){ if(activeViewId!=='view-menu') showView('view-menu'); }, getInactivityLimit()); }

    // Modal
    function showTurnoModal(){ turnoModal.hidden=false; if (modalTimerId) clearTimeout(modalTimerId); modalTimerId=setTimeout(function(){ turnoModal.hidden=true; showView('view-menu'); },3000); }

    // Nombre
    let currentName = "";
    function updateNombreDisplay(){ if(!nombreDisplay)return; if(!currentName){ nombreDisplay.textContent="Toca las letras para escribir tu nombre"; nombreDisplay.classList.add("name-input-row__display--placeholder"); } else { nombreDisplay.textContent=currentName; nombreDisplay.classList.remove("name-input-row__display--placeholder"); } if (nombreInput) nombreInput.value=currentName; }
    function updateNombreConfirmState(){ if(!btnConfirmNombre)return; const ok = currentName && currentName.trim().length>=3; btnConfirmNombre.disabled=!ok; btnConfirmNombre.classList.toggle('btn-turn--disabled',!ok); btnConfirmNombre.classList.toggle('btn-turn--pulse',ok); }
    function resetNombre(){ currentName=""; updateNombreDisplay(); updateNombreConfirmState(); }
    (nombreKeys||[]).forEach(function(btn){ btn.addEventListener('click',function(){ const key=btn.getAttribute('data-key'); if(!key) return; if(key==='BACKSPACE'){ currentName=currentName.slice(0,-1); } else if(key==='SPACE'){ if(currentName && currentName.length<MAX_NAME_CHARS) currentName+=' '; } else { if(currentName.length<MAX_NAME_CHARS) currentName+=key; } updateNombreDisplay(); updateNombreConfirmState(); resetInactivityTimer(); }); });
    updateNombreDisplay(); updateNombreConfirmState();
    if (btnConfirmNombre){ btnConfirmNombre.addEventListener('click', async function(){ const nombre=(currentName||'').trim(); if(nombre.length<3){ resetInactivityTimer(); return; } clearInactivityTimer(); const data = await postJsonAuth(API_URL,{ tipo:'NOMBRE', nombre }); if(!data || !data.turno){ resetInactivityTimer(); return; } showTurnoModal(); }); }
    document.getElementById('btn-volver-menu-name')?.addEventListener('click',function(){ resetNombre(); showView('view-menu'); });

    // Celular
    function resetCellForm(){ if(cellInput) cellInput.value=""; if(cellError) cellError.textContent=""; if(btnConfirmCell){ btnConfirmCell.disabled=true; btnConfirmCell.classList.add('btn-turn--disabled'); btnConfirmCell.classList.remove('btn-turn--pulse'); } }
    function isValidChileMobile(v){ return sanitizePhone(v).length===MAX_CELL_DIGITS; }
    function updateCellConfirmState(){ if(!btnConfirmCell || !cellInput) return; const ok = isValidChileMobile(cellInput.value||''); btnConfirmCell.disabled=!ok; btnConfirmCell.classList.toggle('btn-turn--disabled',!ok); btnConfirmCell.classList.toggle('btn-turn--pulse',ok); }
    function showCellError(m){ if(cellError) cellError.textContent=m||''; }
    (numericKeys||[]).forEach(function(btn){ btn.addEventListener('click',function(){ const key=btn.getAttribute('data-key'); if(!key) return; let v=cellInput.value||''; if(key==='BACKSPACE'){ v=v.slice(0,-1); } else if(key==='CLEAR'){ v=''; } else { if(sanitizePhone(v).length>=MAX_CELL_DIGITS) return; v+=key; } cellInput.value=v; updateCellConfirmState(); showCellError(''); resetInactivityTimer(); }); });
    if (btnConfirmCell && cellInput){ btnConfirmCell.addEventListener('click', async function(){ const v=cellInput.value||''; if(!isValidChileMobile(v)){ showCellError('Número de celular inválido. Debe tener 9 dígitos.'); return; } clearInactivityTimer(); const data = await postJsonAuth(API_URL,{ tipo:'CELULAR', celular: sanitizePhone(v) }); if(!data || !data.turno){ resetInactivityTimer(); return; } showTurnoModal(); }); }
    document.getElementById('btn-volver-menu-cell')?.addEventListener('click',function(){ resetCellForm(); showView('view-menu'); });

    // RUT preferencial (numérico simple)
    let rutDigits = "";
    function formatRutDisplay(d){ if(!d) return ""; const rev=d.split("").reverse(); const out=[]; for(let i=0;i<rev.length;i++){ out.push(rev[i]); if((i+1)%3===0 && i+1<rev.length) out.push("."); } return out.reverse().join(""); }
    function renderRut(){ if(rutInput) rutInput.value = formatRutDisplay(rutDigits); updateRutConfirmState(); }
    function resetRutForm(){ rutDigits=""; if(rutError) rutError.textContent=""; renderRut(); }
    function updateRutConfirmState(){ if(!btnConfirmRut) return; const len=(rutDigits||"").length; const ok = len>=7; btnConfirmRut.disabled=!ok; btnConfirmRut.classList.toggle('btn-turn--disabled',!ok); btnConfirmRut.classList.toggle('btn-turn--pulse', len===MAX_RUT_DIGITS); }
    (rutKeys||[]).forEach(function(btn){ btn.addEventListener('click',function(){ const key=btn.getAttribute('data-key'); if(!key) return; if(key==='BACKSPACE'){ rutDigits=rutDigits.slice(0,-1); } else if(key==='CLEAR'){ rutDigits=''; } else if(/^\d$/.test(key)){ if(rutDigits.length<MAX_RUT_DIGITS) rutDigits+=key; } renderRut(); if(rutError) rutError.textContent=""; resetInactivityTimer(); }); });
    document.getElementById('btn-confirmar-rut')?.addEventListener('click', async function(){ if((rutDigits||'').length<7){ if(rutError) rutError.textContent='Ingresa al menos 7 dígitos de tu RUT.'; return; } clearInactivityTimer(); const data = await postJsonAuth(API_URL,{ tipo:'PREFERENCIAL', rut: rutDigits }); if(!data || !data.turno){ resetInactivityTimer(); return; } showTurnoModal(); });
    document.getElementById('btn-volver-menu-rut')?.addEventListener('click',function(){ resetRutForm(); showView('view-menu'); });

    // Botones menú
    (document.querySelectorAll('[data-view-target]')||[]).forEach(function(btn){
      btn.addEventListener('click',function(){ const target=btn.getAttribute('data-view-target'); if(!target) return;
        if(target==='view-presencial') resetRutForm(); else if(target==='view-cell') resetCellForm(); else if(target==='view-name') resetNombre();
        showView(target);
      });
    });
    // Hint aleatorio en menú
    setInterval(function(){
      if (activeViewId!=='view-menu') return;
      const arr = Array.from(document.querySelectorAll('[data-view-target]')); if(!arr.length) return;
      const btn = arr[Math.floor(Math.random()*arr.length)];
      btn.classList.add('option--hint'); setTimeout(()=>btn.classList.remove('option--hint'),900);
    },5000);

    // Arranque
    startHealthPolling();
  })();
  </script>
</body>
</html>
